# üöÄ Pr≈Øvodce migrac√≠ BLoC ‚Üí Riverpod

Tento pr≈Øvodce ti pom≈Ø≈æe dokonƒçit p≈ôevod projektu **lAidak** z BLoC/Cubit na Riverpod.

## ‚úÖ Co u≈æ je hotov√© (Phase 1 + Phase 2)

### 1. Dependencies
- ‚úÖ P≈ôid√°ny `flutter_riverpod`, `riverpod_annotation`, `riverpod_generator`, `riverpod_lint`
- ‚úÖ `build_runner` p≈ôipraven pro code generation
- ‚úÖ `analysis_options.yaml` nakonfigurov√°n pro Riverpod

### 2. Core Providers
- ‚úÖ `lib/core/providers/core_providers.dart` - DatabaseHelper, HTTP client, TagService
- ‚úÖ `lib/core/providers/repository_providers.dart` - V≈°echny repository providers

### 3. Kompletn√≠ konverze (Phase 1 + Phase 2)

#### Settings & Connectivity
- ‚úÖ **SettingsCubit** ‚Üí `lib/features/settings/presentation/providers/settings_provider.dart`
  - Pou≈æ√≠v√° `@riverpod` + AsyncNotifier
  - Uk√°zka async state managementu

- ‚úÖ **ConnectivityCubit** ‚Üí `lib/core/connectivity/providers/connectivity_provider.dart`
  - Pou≈æ√≠v√° StreamNotifier
  - Uk√°zka real-time stream monitoring

#### Core Features
- ‚úÖ **TodoListBloc** ‚Üí `lib/features/todo_list/presentation/providers/todo_provider.dart`
  - Kompletn√≠ p≈ôevod vƒçetnƒõ search, filter, sort, AI Brief
  - Helper providers: displayedTodos, expandedTodoId, currentViewMode

#### AI Features
- ‚úÖ **MotivationCubit** ‚Üí `lib/features/ai_motivation/presentation/providers/motivation_provider.dart`
  - Jednoduch√Ω Notifier pro motivaƒçn√≠ zpr√°vy

- ‚úÖ **AiSplitCubit** ‚Üí `lib/features/ai_split/presentation/providers/ai_split_provider.dart`
  - Rozdƒõlov√°n√≠ √∫kol≈Ø pomoc√≠ AI

- ‚úÖ **PrankCubit** ‚Üí `lib/features/ai_prank/presentation/providers/prank_provider.dart`
  - Pranky + good deeds po dokonƒçen√≠ √∫kolu

### 4. Main entry point
- ‚úÖ `lib/main_riverpod.dart` - Nov√Ω main.dart s ProviderScope
  - Nahrazuje MultiBlocProvider
  - Pou≈æ√≠v√° `ref.watch()` m√≠sto `BlocBuilder`
  - Importuje v≈°echny nov√© providers

---

## üìã Co zb√Ωv√° udƒõlat

### Krok 1: Spustit build_runner

Nejprve vygeneruj `.g.dart` soubory pro riverpod_annotation:

```bash
flutter pub get
flutter pub run build_runner build --delete-conflicting-outputs
```

To vytvo≈ô√≠ `.g.dart` soubory pro v≈°echny providery:
- `lib/features/settings/presentation/providers/settings_provider.g.dart`
- `lib/core/connectivity/providers/connectivity_provider.g.dart`
- `lib/features/todo_list/presentation/providers/todo_provider.g.dart`
- `lib/features/ai_motivation/presentation/providers/motivation_provider.g.dart`
- `lib/features/ai_split/presentation/providers/ai_split_provider.g.dart`
- `lib/features/ai_prank/presentation/providers/prank_provider.g.dart`

### Krok 2: P≈ôev√©st zbyl√© BLoC/Cubit (voliteln√©)

**Hlavn√≠ features jsou hotov√©!** Zb√Ωvaj√≠c√≠ blocy jsou m√©nƒõ kritick√©:

#### üü¢ Priority 3 (ostatn√≠ - lze p≈ôev√©st postupnƒõ)

**NotesBloc** ‚Üí `lib/features/notes/presentation/providers/notes_provider.dart`
**ProfileBloc** ‚Üí `lib/features/profile/presentation/providers/profile_provider.dart`
**PomodoroBloc** ‚Üí `lib/features/pomodoro/presentation/providers/pomodoro_provider.dart`
**TagManagementCubit** ‚Üí `lib/features/tag_management/presentation/providers/tag_management_provider.dart`
**AiChatBloc** ‚Üí `lib/features/ai_chat/presentation/providers/ai_chat_provider.dart`

Pou≈æij stejn√Ω pattern jako u TodoList provideru.

---

## üîÑ Pattern pro p≈ôevod

### BLoC ‚Üí AsyncNotifier (async operations)

**P≈ôed (BLoC):**
```dart
class TodoListBloc extends Bloc<TodoEvent, TodoState> {
  TodoListBloc(this._repository) : super(TodoInitial()) {
    on<LoadTodos>(_onLoadTodos);
  }

  Future<void> _onLoadTodos(LoadTodos event, Emitter emit) async {
    emit(TodoLoading());
    try {
      final todos = await _repository.getTodos();
      emit(TodoLoaded(todos));
    } catch (e) {
      emit(TodoError(e.toString()));
    }
  }
}
```

**Po (Riverpod):**
```dart
@riverpod
class TodoList extends _$TodoList {
  @override
  Future<TodoState> build() async {
    final todos = await ref.read(todoRepositoryProvider).getTodos();
    return TodoLoaded(todos);
  }

  Future<void> loadTodos() async {
    state = const AsyncValue.loading();
    state = await AsyncValue.guard(() async {
      final todos = await ref.read(todoRepositoryProvider).getTodos();
      return TodoLoaded(todos);
    });
  }

  Future<void> addTodo(Todo todo) async {
    await ref.read(todoRepositoryProvider).addTodo(todo);
    ref.invalidateSelf(); // Re-run build()
  }
}
```

### Cubit ‚Üí Notifier (synchronn√≠ state)

**P≈ôed (Cubit):**
```dart
class MotivationCubit extends Cubit<MotivationState> {
  MotivationCubit(this._repository) : super(MotivationInitial());

  Future<void> generateMotivation() async {
    emit(MotivationLoading());
    try {
      final text = await _repository.generateMotivation();
      emit(MotivationLoaded(text));
    } catch (e) {
      emit(MotivationError(e.toString()));
    }
  }
}
```

**Po (Riverpod):**
```dart
@riverpod
class Motivation extends _$Motivation {
  @override
  MotivationState build() {
    return const MotivationInitial();
  }

  Future<void> generateMotivation() async {
    state = const MotivationLoading();
    try {
      final text = await ref.read(motivationRepositoryProvider).generateMotivation();
      state = MotivationLoaded(text);
    } catch (e) {
      state = MotivationError(e.toString());
    }
  }
}
```

---

## üé® Aktualizace UI widget≈Ø

### BlocBuilder ‚Üí Consumer/ref.watch

**P≈ôed:**
```dart
BlocBuilder<TodoListBloc, TodoState>(
  builder: (context, state) {
    if (state is TodoLoading) {
      return CircularProgressIndicator();
    } else if (state is TodoLoaded) {
      return ListView.builder(...);
    }
    return SizedBox.shrink();
  },
)
```

**Po (Option 1 - Consumer):**
```dart
Consumer(
  builder: (context, ref, child) {
    final todoAsync = ref.watch(todoListProvider);

    return todoAsync.when(
      data: (todoState) {
        if (todoState is TodoLoaded) {
          return ListView.builder(...);
        }
        return SizedBox.shrink();
      },
      loading: () => CircularProgressIndicator(),
      error: (err, stack) => Text('Error: $err'),
    );
  },
)
```

**Po (Option 2 - ConsumerWidget):**
```dart
class TodoListView extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final todoAsync = ref.watch(todoListProvider);

    return todoAsync.when(
      data: (todoState) {
        if (todoState is TodoLoaded) {
          return ListView.builder(...);
        }
        return SizedBox.shrink();
      },
      loading: () => CircularProgressIndicator(),
      error: (err, stack) => Text('Error: $err'),
    );
  }
}
```

### BlocConsumer ‚Üí ref.listen + ref.watch

**P≈ôed:**
```dart
BlocConsumer<TodoListBloc, TodoState>(
  listener: (context, state) {
    if (state is TodoError) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text(state.message)),
      );
    }
  },
  builder: (context, state) {
    // ...
  },
)
```

**Po:**
```dart
class TodoListView extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    // Listen for errors
    ref.listen<AsyncValue<TodoState>>(todoListProvider, (previous, next) {
      next.whenOrNull(
        error: (error, stack) {
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(content: Text(error.toString())),
          );
        },
      );
    });

    // Watch for state changes
    final todoAsync = ref.watch(todoListProvider);

    return todoAsync.when(
      // ...
    );
  }
}
```

### context.read ‚Üí ref.read

**P≈ôed:**
```dart
context.read<TodoListBloc>().add(AddTodoEvent(todo));
```

**Po:**
```dart
ref.read(todoListProvider.notifier).addTodo(todo);
```

---

## üõ†Ô∏è Testov√°n√≠ migrace

### 1. Postupn√° migrace

M≈Ø≈æe≈° m√≠t BLoC i Riverpod souƒçasnƒõ! P≈ôepi≈° nejd≈ô√≠v jedno feature a otestuj:

```dart
runApp(
  ProviderScope(
    child: MultiBlocProvider(
      providers: [
        // Star√° BLoC features (co je≈°tƒõ nejsou p≈ôeveden√©)
        BlocProvider(create: (_) => TodoListBloc(...)),

        // Nov√© Riverpod providers jsou dostupn√© p≈ôes ProviderScope
      ],
      child: TodoApp(),
    ),
  ),
);
```

### 2. P≈ôepnut√≠ na main_riverpod.dart

Kdy≈æ m√°≈° p≈ôeveden√© kl√≠ƒçov√© features:

```bash
# Z√°loha star√©ho main.dart
mv lib/main.dart lib/main_bloc.dart

# Aktivuj Riverpod verzi
mv lib/main_riverpod.dart lib/main.dart
```

### 3. Spu≈°tƒõn√≠

```bash
flutter pub run build_runner watch  # Auto-regenerate p≈ôi zmƒõn√°ch
flutter run
```

---

## üéØ Doporuƒçen√Ω postup

1. **‚úÖ F√°ze 1 HOTOV√Å**: Settings + Connectivity
2. **‚úÖ F√°ze 2 HOTOV√Å**: TodoList + AI features (Motivation, Split, Prank)
3. **F√°ze 3**: P≈ôeveƒè zbyl√© (Notes, Profile, Pomodoro, TagManagement, AiChat) - voliteln√©
4. **F√°ze 4**: Spus≈• build_runner a otestuj aplikaci
5. **F√°ze 5**: Aktualizuj UI widgety postupnƒõ (m≈Ø≈æe≈° zaƒç√≠t jednou feature)
6. **F√°ze 6**: Odstranƒõn√≠ BLoC dependencies (a≈æ bude v≈°e p≈ôeveden√©)

---

## üìö U≈æiteƒçn√© zdroje

- [Riverpod Documentation](https://riverpod.dev/)
- [Migrace z BLoC](https://riverpod.dev/docs/from_provider/motivation)
- [Code Generation](https://riverpod.dev/docs/concepts/about_code_generation)
- [AsyncNotifier](https://riverpod.dev/docs/providers/notifier_provider)
- [StreamNotifier](https://riverpod.dev/docs/providers/stream_provider)

---

## ‚ö†Ô∏è ƒåast√© probl√©my

### Problem: "part 'xxx.g.dart' doesn't exist"
**≈òe≈°en√≠:** Spus≈• `flutter pub run build_runner build`

### Problem: Provider ne found
**≈òe≈°en√≠:** Zkontroluj ≈æe m√°≈° `ProviderScope` v `main.dart`

### Problem: Circular dependency
**≈òe≈°en√≠:** Pou≈æij `ref.read()` pro jednor√°zov√© ƒçten√≠, `ref.watch()` pro reaktivn√≠ observov√°n√≠

---

## üéâ V√Ωhody Riverpod oproti BLoC

- ‚úÖ **Compile-time safety** - chyby p≈ôi kompilaci m√≠sto runtime
- ‚úÖ **M√©nƒõ boilerplate** - ≈æ√°dn√© Events, m√©nƒõ soubor≈Ø
- ‚úÖ **Lep≈°√≠ testov√°n√≠** - snaz≈°√≠ mockov√°n√≠ providers
- ‚úÖ **Auto-disposal** - automatick√© ƒçi≈°tƒõn√≠ resources
- ‚úÖ **DevTools** - lep≈°√≠ debugging s Riverpod DevTools
- ‚úÖ **Scoped providers** - per-route nebo per-widget state
- ‚úÖ **Familie providers** - parametrizovan√© providers

Hodnƒõ ≈°tƒõst√≠ s migrac√≠! üöÄ
